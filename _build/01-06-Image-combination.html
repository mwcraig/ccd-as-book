---
redirect_from:
  - "01-06-image-combination"
interact_link: content/01-06-Image-combination.ipynb
kernel_name: python3
has_widgets: false
title: |-
  Image combination
prev_page:
  url: /01-05-Calibration-overview.html
  title: |-
    Calibration overview
next_page:
  url: /01-08-Overscan.html
  title: |-
    Overscan
suffix: .ipynb

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    
<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Image-combination">Image combination<a class="anchor-link" href="#Image-combination"> </a></h1><p>Image combination serves several purposes. Combining images:</p>
<ul>
<li>reduces noise in images</li>
<li>can remove transient artifacts like cosmic rays and satellite tracks</li>
<li>can remove stars in <a href="FIX_LINK">flat images taken at twilight</a></li>
</ul>
<p>It's essential that several of each type of calibration image (bias, dark, flat)
be taken. Combining them reduces the noise in the images by roughly a factor of
$1/\sqrt{N}$, where $N$ is the number of images being combined. As shown in the
previous notebook, using a single calibration image actually <em>increases</em> the
noise in your image.</p>
<p>There are a few ways to combine images; if done properly, features that show up
in only one of the images (like cosmic rays) are not present in the combination.
If done incorrectly, those features show up in your combined images and then
contaminate your calibrated science images too.</p>
<h3 id="The-bottom-line:-combine-by-averaging-images,-but-clip-extreme-values">The bottom line: combine by averaging images, but clip extreme values<a class="anchor-link" href="#The-bottom-line:-combine-by-averaging-images,-but-clip-extreme-values"> </a></h3><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R26" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>The remainder of this notebook demonstrates this conclusion and explains how to
do a combination by averaging images with <a href="https://ccdproc.readthedocs.io/en/latest/">ccdproc</a>.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">rc</span>

<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="k">import</span> <span class="n">hist</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">mad_std</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Use custom style for larger fonts and figures</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;guide.mplstyle&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Set some default parameters for the plots below</span>
<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combination-method:-average-or-median?">Combination method: average or median?<a class="anchor-link" href="#Combination-method:-average-or-median?"> </a></h2><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R73" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>In this section we'll look at a simplified version of the challenges of
combining images to reduce noise. It's fair to think of astronomical images
(especially bias and dark images) as being a Gaussian distribution of pixel
values around the bias level, and a width related to the read noise of the
detector. To simplify what follows, we will work arrays of random numbers drawn
from a Gaussian distribution instead of with astronomical images.</p>
<p>In properly done flat images the noise is technically a Poisson distribution,
but with a large enough number of counts, the distribution is indistinguishable
from a Gaussian distribution whose width is related to the square root of the
number of counts. While some regions of a science image are dominated by Poisson
noise from sources in the image, most of the image will be dominated by Gaussian
read noise from the detector or Poisson noise from the sky background.</p>
<p>Instead of working with a combination of images, we'll create 100 Gaussian
distributions with a mean of zero, and a standard deviation of one, and combine
those two different ways: by finding the average and by finding the median. Each
distribution has size $320^2$ so that we can view it as either a distribution of
102,400 values or as an image that is $320 \times 320$.</p>
<p>We can think of each of these 100 distributions as representing an image, like a
bias or dark. To make the analogy to real images a little more direct, a "bias"
of 1000 is added to each distribution.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_distributions</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">bias_level</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">n_side</span> <span class="o">=</span> <span class="mi">320</span>
<span class="n">bits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_distributions</span><span class="p">,</span> <span class="n">n_side</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">bias_level</span>
<span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we've created the distributions and combined them in two different
ways, let's take a look at them. The <a href="https://astropy.readthedocs.io/en/stable/visualization/histogram.html"><code>hist</code> function from astropy.visualization</a> is used
below because it can figure out what bin size to use for your data.</p>
<!-- *Note: but beware https://github.com/astropy/astropy/issues/7758* -->
</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">hist</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;One sample distribution&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>

<span class="n">hist</span><span class="p">(</span><span class="n">average</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">hist</span><span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> distributions combined&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_distributions</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.legend.Legend at 0x120030e10&gt;</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="images/01-06-Image-combination_7_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Combining by averaging gives a narrower (i.e. less noisy) distribution than
combining by median, though both substantially reduced the width of the
distribution. The conclusion so far is that combining by averaging is mildly
preferable to combining by median. Computationally, the mean is also faster to
compute than the median.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Image-view-of-these-distributions">Image view of these distributions<a class="anchor-link" href="#Image-view-of-these-distributions"> </a></h3><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R160" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>As suggested above, we could view each of these distributions as an image
instead of a histogram. One take away from the diagram below is that in this
case, the difference between mean and median is not apparent.</p>
<p>In all cases, the extreme values of the image display are set to bracket the
width of the initial distribution.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">data_source</span> <span class="o">=</span> <span class="p">[</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">average</span><span class="p">,</span> <span class="n">median</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;One distrbution&#39;</span><span class="p">,</span> <span class="s1">&#39;Average of </span><span class="si">{n}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_distributions</span><span class="p">),</span> <span class="s1">&#39;Median of </span><span class="si">{n}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_distributions</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_side</span><span class="p">,</span> <span class="n">n_side</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">bias_level</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">bias_level</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="images/01-06-Image-combination_10_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-effect-of-outliers">The effect of outliers<a class="anchor-link" href="#The-effect-of-outliers"> </a></h2><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R192" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>Suppose that, in just one of the 100 distributions we're combining, there are a
small number of extreme values. In astronomical images these extremes happen
very frequently because of cosmic ray hits on the detector that cause, in one
small patch of a calibration image, much higher counts. Another case occurs when
combining twilight flats, which often contain faint images of stars.</p>
<p>In the example below, we set just 50 points out of the 102,400 in the first
distribution to a somewhat higher value than the rest.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">:</span><span class="mi">10050</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bias_level</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Remember, we can think of the values in this distribution as an image, a view
that will be particularly convenient in this case.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_side</span><span class="p">,</span> <span class="n">n_side</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">bias_level</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">bias_level</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;One distribution with outliers&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="images/01-06-Image-combination_14_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we know what the outliers in this (and <em>only</em> this) distribution look
like, we'll combine all of the distributions as we did above.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Even though only one out of the 100 "images" we're combining has these high
pixel values, the distribution of pixels for the average is clearly affected
(well, maybe not clearly, since seeing it requires a logarithmic $y$-axis). The
distribution for the median looks much the same as above. Since median simply
looks for the middle value, an extreme value doesn't affect the result too much.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">hist</span><span class="p">(</span><span class="n">average</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">);</span>
<span class="n">hist</span><span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">();</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="images/01-06-Image-combination_18_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Combining-using-the-average-has-a-noticeable-effect-on-the-result;-median">Combining using the average has a noticeable effect on the result; median<a class="anchor-link" href="#Combining-using-the-average-has-a-noticeable-effect-on-the-result;-median"> </a></h3><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R282" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a>
removes the artifact</p>
<p>The effect of the outlier is <em>much</em> clearer if the distributions are displayed
as images. If the distributions we're combining were calibration images then the
outliers that appear in one image (e.g. a cosmic ray) would affect the combined
image we hoped to use for calibration.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">data_source</span> <span class="o">=</span> <span class="p">[</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">average</span><span class="p">,</span> <span class="n">median</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;One distribution with outliers&#39;</span><span class="p">,</span> <span class="s1">&#39;Average of </span><span class="si">{n}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_distributions</span><span class="p">),</span> <span class="s1">&#39;Median of </span><span class="si">{n}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_distributions</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_side</span><span class="p">,</span> <span class="n">n_side</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="n">bias_level</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">bias_level</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="images/01-06-Image-combination_20_0.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>On one hand, the noise properties are better when you combine by taking the
average. On the other hand, the median eliminates features that appear in only
one image.</p>
<p>Astronomical images will almost always have those transient features. Even at an
observatory near sea level in an exposure that is very short, cosmic ray hits
are common.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-solution:-average-combine,-but-clip-the-extreme-values">The solution: average combine, but clip the extreme values<a class="anchor-link" href="#The-solution:-average-combine,-but-clip-the-extreme-values"> </a></h2><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R326" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>The answer here is to first clip extreme values from the distributions and then
combine using the average. That rejects outlying values like the median but with
the modestly better statistical properties of the average. A method called
"sigma clipping" is used to remove the extreme values.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Please do not use the code below for reducing your data...</strong></p>
<p>...in the next set of notebooks we'll walk through the package
<a href="https://ccdproc.readthedocs.io">ccdproc</a>, which automates much of what you see below.
The section below demonstrates and explains some of what's happening behind the
scenes in <a href="https://ccdproc.readthedocs.io">ccdproc</a>.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sigma-clipping">Sigma clipping<a class="anchor-link" href="#Sigma-clipping"> </a></h3><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R350" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>Sigma clipping means calculating how "far" each pixel to be combined is from the
"typical" value and excluding values from the combination if they are "too far"
from the pixel value.</p>
<p>To be clear, when evaluating which values to reject we're doing it for each of
the 102,400 points in the distribution (or, if you prefer, each of the
320$\times$320 pixels in the image) we're going to combine. In other words, for
each point (or pixel), we'll compute a "typical" value for the 100 distributions
(images) we're combining and exclude any from the average that are "too far"
from the "typical value."</p>
<p>What should be used as the "typical" value, how do we measure how "far" away a
value is, and how far is "too far"?</p>
<p>The last question is easiest to answer: it depends a bit on the noise level in
your camera but something like 5 farther from the "typical" value than most of
the pixels are.</p>
<p>Using the average as the typical value and the standard deviation as a measure
of how far a particular value is from the typical value is often not the best
choice. The problem with this is that outlying values in a single distribution
(or image) strongly bias the average and exaggerate the standard deviation. In
this example, where we're combining 100 distributions (images), using the
average and standard deviation might work since there are so many distributions.
A more typical number of bias or dark images that one might combine is 10 or 20.
In that case, an extreme value in one image strongly affects the mean and
standard deviation.</p>
<p>As an example, consider combining 10, 20, or 100 of our distributions, as shown
in the cell below. Only in the case of 100 distributions would our extreme value
of 2000 be excluded if we excluded values more than 5 times the standard
deviation from the average.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number combined</span><span class="se">\t</span><span class="s1"> Average</span><span class="se">\t</span><span class="s1"> Standard dev σ </span><span class="se">\t</span><span class="s1"> 10σ &#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">n_to_combine</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_distributions</span><span class="p">]:</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bits</span><span class="p">[:</span><span class="n">n_to_combine</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bits</span><span class="p">[:</span><span class="n">n_to_combine</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{n:10d}</span><span class="se">\t</span><span class="si">{avg:10.2f}</span><span class="se">\t</span><span class="si">{std:10.2f}</span><span class="se">\t</span><span class="si">{ten_sig:10.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_to_combine</span><span class="p">,</span> 
                                         <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span> 
                                         <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">ten_sig</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Number combined	 Average	 Standard dev σ 	 10σ 
        10	   1100.23	    299.93	   2999.25
        20	   1050.07	    217.93	   2179.32
       100	   1009.93	     99.51	    995.10
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A better choice is to use the median as the typical value and the <em>median
absolute deviation</em> in place of the standard deviation as the measure of how far
a value is from the typical value. The <a href="https://en.wikipedia.org/wiki/Median_absolute_deviation">median absolute deviation</a>, or MAD,
of a set of points $x$ is defined by:
$$
MAD = \frac{1}{N}\sum_{i=0}^N |x_i - \text{median}(x)|.
$$
This is a measure of the typical absolute distance from the median of the set of
values. The MAD is not directly equivalent to the standard deviation. The
relationship between the two depends on the distribution of values, but for a
Gaussian distribution multiplying the MAD by 1.4826 does the trick. The
<a href="http://docs.astropy.org/en/stable/api/astropy.stats.mad_std.html">astropy function <code>mad_std</code></a> will calculate the MAD and multiply by the
appropriate factor for you.</p>
<p>Repeating the calculation above but with median as the central value and the MAD
in place of the standard deviation demonstrates that even for 10 distributions
the extreme value will be excluded.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:^20}{:^20}{:^20}{:^20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Number combined&#39;</span><span class="p">,</span> <span class="s1">&#39;Median&#39;</span><span class="p">,</span> <span class="s1">&#39;MAD σ&#39;</span><span class="p">,</span> <span class="s1">&#39;10σ&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">n_to_combine</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_distributions</span><span class="p">]:</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bits</span><span class="p">[:</span><span class="n">n_to_combine</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">mad_std</span><span class="p">(</span><span class="n">bits</span><span class="p">[:</span><span class="n">n_to_combine</span><span class="p">,</span> <span class="mi">10000</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{n:^20d}{avg:^20.2f}{std:^20.2f}{ten_sig:^20.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_to_combine</span><span class="p">,</span> 
                                         <span class="n">avg</span><span class="o">=</span><span class="n">avg</span><span class="p">,</span> 
                                         <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">ten_sig</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">std</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>  Number combined          Median              MAD σ                10σ         
         10               1000.31               1.20               11.97        
         20               1000.22               1.20               11.97        
        100                999.82               0.86                8.61        
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The downside to using the median and median absolute deviation? They can be slow
to compute for large images or large stacks of images.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The cells below perform the actual clipping; you should generally use the
astropy function <a href="https://astropy.readthedocs.io/en/stable/stats/robust.html"><code>sigma_clip</code></a> to do this, but here we'll do
it manually to illustrate the process.</p>
<p>We begin by calculating the MAD standard deviation estimator for our data.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mad_sigma</span> <span class="o">=</span> <span class="n">mad_std</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The expression below is true for all of the points farther than $10
\sigma_{MAD}$ from the median of the distributions and false everywhere else.
This array will be used to exclude the extreme points.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">/</span> <span class="n">mad_sigma</span> <span class="o">&gt;</span> <span class="mi">10</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we calculate the average, excluding the points identified as "too far"
from from the median. There are two approaches we can take here. One is to use
numpy masked arrays; the other is to temporarily set the excluded values to the
special value <code>np.nan</code> and use a numpy function that excludes <code>nan</code> from the
calculation. The latter approach is often faster than the former.</p>
<p>The best approach is really to use a higher-level function from astropy for
ccdproc. Those will take care of the details of implementing the clipping for
you.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">original_values</span> <span class="o">=</span> <span class="n">bits</span><span class="p">[</span><span class="n">exclude</span><span class="p">]</span>
<span class="n">bits</span><span class="p">[</span><span class="n">exclude</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="n">clip_combine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bits</span><span class="p">[</span><span class="n">exclude</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_values</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="#Summary"> </a></h2><p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/215/files#diff-976ff4558111a0c8cd9acea1b437a089R520" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>
<p>Combine images by (1) excluding extreme values using sigma clipping, with the
median as the typical value and the MAD estimator of the standard deviation, and
then (2) averaging the remaining pixels across all of the images.</p>
<p>Note that in the distribution below the clipped average is a narrower
distribution (less noise) than the median but that it still excludes the extreme
value that appeared in one image.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">hist</span><span class="p">(</span><span class="n">clip_combine</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;clipped average&#39;</span><span class="p">)</span>
<span class="n">hist</span><span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Text(0, 0.5, &#39;Number of pixels&#39;)</pre>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="images/01-06-Image-combination_36_1.png"
>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

 


    </main>
    
