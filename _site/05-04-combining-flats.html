<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>Combining flat frames</title>
  <meta name="description" content="Combining flatsThere is one step in combining flats that is different from most other imagecombination: the flats should be scaled to a common value before c...">

  <link rel="canonical" href="/YOUR%20URL//05-04-Combining-flats.html">
  <link rel="alternate" type="application/rss+xml" title="CCD Data Reduction Guide" href="/YOUR%20URL//feed.xml">

  <meta property="og:url"         content="/YOUR%20URL//05-04-Combining-flats.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Combining flat frames" />
<meta property="og:description" content="Combining flatsThere is one step in combining flats that is different from most other imagecombination: the flats should be scaled to a common value before c..." />
<meta property="og:image"       content="YOUR%20URL/images/logo/logo.png" />

<meta name="twitter:card" content="summary">


  <script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": "YOUR URL//05-04-Combining-flats.html",
  "headline": "Combining flat frames",
  "datePublished": "2020-10-21T10:29:31-05:00",
  "dateModified": "2020-10-21T10:29:31-05:00",
  "description": "Combining flatsThere is one step in combining flats that is different from most other imagecombination: the flats should be scaled to a common value before c...",
  "author": {
    "@type": "Person",
    "name": "Matthew Craig"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Data 100 at UC Berkeley",
    "logo": {
      "@type": "ImageObject",
      "url": "YOUR URL/",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "YOUR URL/",
    "height": 60,
    "width": 60
  }
}

  </script>
  <link rel="stylesheet" href="/assets/css/styles.css">

  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/images/logo/favicon.ico">

  <!-- MathJax Config -->
  <!-- Allow inline math using $ and automatically break long math lines -->
<!-- (mostly) copied from nbconvert configuration -->
<!-- https://github.com/jupyter/nbconvert/blob/master/nbconvert/templates/html/mathjax.tpl -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    // Center justify equations in code and markdown cells. Elsewhere
    // we use CSS to left justify single line equations in code cells.
    displayAlign: 'center',
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}},
        linebreaks: { automatic: true },
    }
});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML' async></script>


  <!-- DOM updating function -->
  <script src="/assets/js/page/dom-update.js"></script>

  <!-- Selectors for elements on the page -->
  <script src="/assets/js/page/documentSelectors.js"></script>

  <!-- Define some javascript variables that will be useful in other javascript -->
  <script>
    const site_basename = '/';
  </script>

  <!-- Add AnchorJS to let headers be linked -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js" async></script>
  <script src="/assets/js/page/anchors.js" async></script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js" async></script>
  <meta name="turbolinks-cache-control" content="no-cache">

  <!-- Load nbinteract for widgets -->
  

  <!-- Load Thebelab for interactive widgets -->
  <!-- Include Thebelab for interactive code if it's enabled -->



  <!-- Load the auto-generating TOC (non-async otherwise the TOC won't load w/ turbolinks) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js" async></script>
  <script src="/assets/js/page/tocbot.js"></script>

  <!-- Google analytics -->
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>



  <!-- Clipboard copy button -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script>

  <!-- Load custom website scripts -->
  <script src="/assets/js/scripts.js" async></script>

  <!-- Load custom user CSS and JS  -->
  <script src="/assets/custom/custom.js" async></script>
  <link rel="stylesheet" href="/assets/custom/custom.css">

  <!-- Update interact links w/ REST param, is defined in includes so we can use templates -->
  

  <!-- Lunr search code - will only be executed on the /search page -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.6/lunr.min.js" async></script>
  <script>var initQuery = function() {
  // See if we have a search box
  var searchInput = document.querySelector('input#lunr_search');
  if (searchInput === null) {
    return;
  }

  // Function to parse our lunr cache
  var idx = lunr(function () {
    this.field('title')
    this.field('excerpt')
    this.field('categories')
    this.field('tags')
    this.ref('id')

    this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        title: store[item].title,
        excerpt: store[item].excerpt,
        categories: store[item].categories,
        tags: store[item].tags,
        id: item
      })
    }
  });

  // Run search upon keyup
  searchInput.addEventListener('keyup', function () {
    var resultdiv = document.querySelector('#results');
    var query = document.querySelector("input#lunr_search").value.toLowerCase();
    var result =
      idx.query(function (q) {
        query.split(lunr.tokenizer.separator).forEach(function (term) {
          q.term(term, { boost: 100 })
          if(query.lastIndexOf(" ") != query.length-1){
            q.term(term, {  usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 })
          }
          if (term != ""){
            q.term(term, {  usePipeline: false, editDistance: 1, boost: 1 })
          }
        })
      });

      // Empty the results div
      while (resultdiv.firstChild) {
        resultdiv.removeChild(resultdiv.firstChild);
      }

    resultdiv.insertAdjacentHTML('afterbegin', '<p class="results__found">'+result.length+' Result(s) found</p>');
    for (var item in result) {
      var ref = result[item].ref;
      if(store[ref].teaser){
        var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<div class="archive__item-teaser">'+
                '<img src="'+store[ref].teaser+'" alt="">'+
              '</div>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      else{
    	  var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      resultdiv.insertAdjacentHTML('beforeend', searchitem);
    }
  });
};

initFunction(initQuery);
</script>

  <!-- Load JS that depends on site variables -->
  <script src="/assets/js/page/copy-button.js" async></script>

  <!-- Hide cell code -->
  <script src="/assets/js/page/hide-cell.js" async></script>

  <!-- Printing the screen -->
  <!-- Include nbinteract for interactive widgets -->
<script src="https://printjs-4de6.kxcdn.com/print.min.js" async></script>
<script>
printContent = () => {
    // MathJax displays a second version of any math for assistive devices etc.
    // This prevents double-rendering in the PDF output.
    var ignoreAssistList = [];
    assistives = document.querySelectorAll('.MathJax_Display span.MJX_Assistive_MathML').forEach((element, index) => {
        var thisId = 'MathJax-assistive-' + index.toString();
        element.setAttribute('id', thisId);
        ignoreAssistList.push(thisId)
    });

    // Print the actual content object
    printJS({
        printable: 'textbook_content',
        type: 'html',
        css: "/assets/css/styles.css",
        style: "#textbook_content {padding-top: 40px};",
        scanStyles: false,
        targetStyles: ["*"],
        ignoreElements: ignoreAssistList,
        documentTitle: "Made with Jupyter Book"
    })
};

initPrint = () => {
    document.querySelector('#interact-button-print').addEventListener('click', printContent)
}

initFunction(initPrint)
</script>

</head>

  <body>
    <!-- .js-show-sidebar shows sidebar by default -->
    <div id="js-textbook" class="c-textbook js-show-sidebar">
      



<nav id="js-sidebar" class="c-textbook__sidebar">
  <a href="https://jupyter.org/jupyter-book/"><img src="/images/logo/logo.png" class="textbook_logo" id="sidebar-logo" alt="textbook logo" data-turbolinks-permanent/></a>
  <h2 class="c-sidebar__title">CCD Data Reduction Guide</h2>
  <ul class="c-sidebar__chapters">
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/00-00-Preface.html"
        >
          
          Home
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href=".html"
        >
          
            1.
          
          Search
        </a>

        
      </li>

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
      
      
        <li><h2 class="c-sidebar__title">CCD Data Reduction Guide</li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/01-00-Understanding-an-astronomical-CCD-image.html"
        >
          
            2.
          
          Understanding astronomical images
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-03-Construction-of-an-artificial-but-realistic-image.html"
                >
                  
                    2.1
                  
                  An artificial, but realistic, image
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-04-Nonuniform-sensitivity.html"
                >
                  
                    2.2
                  
                  Non-uniform sensitivity in astronomical detectors
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-05-Calibration-overview.html"
                >
                  
                    2.3
                  
                  Calibration overview
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-06-Image-combination.html"
                >
                  
                    2.4
                  
                  Image combination
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-08-Overscan.html"
                >
                  
                    2.5
                  
                  Overscan
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-09-Calibration-choices-you-need-to-make.html"
                >
                  
                    2.6
                  
                  Calibration choices to make
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-11-reading-images.html"
                >
                  
                    2.7
                  
                  Reading images
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/02-00-Handling-overscan-trimming-and-bias-subtraction.html"
        >
          
            3.
          
          Overscan and bias images
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/02-01-Calibrating-bias-images.html"
                >
                  
                    3.1
                  
                  Calibrating bias images
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/02-04-Combine-bias-images-to-make-master.html"
                >
                  
                    3.2
                  
                  Combine bias images to make master bias
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/03-00-Dark-current-and-hot-pixels.html"
        >
          
            4.
          
          Dark current and dark frames
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-01-Dark-current-The-ideal-case.html"
                >
                  
                    4.1
                  
                  Dark current: the ideal case
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-02-Real-dark-current-noise-and-other-artifacts.html"
                >
                  
                    4.2
                  
                  Real dark current: noise and other artifacts
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-04-Handling-overscan-and-bias-for-dark-frames.html"
                >
                  
                    4.3
                  
                  Handling overscan and bias for dark frames
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-05-Calibrate-dark-images.html"
                >
                  
                    4.4
                  
                  Calibrate dark images
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-06-Combine-darks-for-use-in-later-calibration-steps.html"
                >
                  
                    4.5
                  
                  Combine calibrated dark images for use in later reduction steps
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/05-00-Flat-corrections.html"
        >
          
            5.
          
          Flat fielding
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/05-03-Calibrating-the-flats.html"
                >
                  
                    5.1
                  
                  Calibrating flat frames
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry c-sidebar__entry--active"
                  href="/05-04-Combining-flats.html"
                >
                  
                    5.2
                  
                  Combining flat frames
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/06-00-Reducing-science-images.html"
        >
          
            6.
          
          Calibrating science images
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/08-00-Image-masking.html"
        >
          
            7.
          
          Finding and dealing with bad pixels
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-01-Identifying-hot-pixels.html"
                >
                  
                    7.1
                  
                  Identifying hot pixels
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-02-Creating-a-mask.html"
                >
                  
                    7.2
                  
                  Identifying bad pixels with ccdmask
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-03-Cosmic-ray-removal.html"
                >
                  
                    7.3
                  
                  Removing cosmic rays
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-05-incorporating-masks-into-calibrated-science-images.html"
                >
                  
                    7.4
                  
                  Incorporating masks in science images
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://github.com/astropy/ccd-reduction-and-photometry-guide"
        >
          
          GitHub repository
        </a>

        
      </li>

      
    
  </ul>
  <p class="sidebar_footer">Powered by <a href="https://github.com/jupyter/jupyter-book">Jupyter Book</a> and <a href="https://astropy.org">Astropy</a></p>
</nav>

      
      <div class="c-topbar" id="top-navbar">
  <!-- We show the sidebar by default so we use .is-active -->
  <div class="c-topbar__buttons">
    <button
      id="js-sidebar-toggle"
      class="hamburger hamburger--arrowalt is-active"
    >
      <span class="hamburger-box">
        <span class="hamburger-inner"></span>
      </span>
    </button>
    <div class="buttons">
<div class="download-buttons-dropdown">
    <button id="dropdown-button-trigger" class="interact-button"><img src="/assets/images/download-solid.svg" alt="Download" /></button>
    <div class="download-buttons">
        <a href="/content/05-04-Combining-flats.ipynb" download>
        <button id="interact-button-download" class="interact-button"></button>
        </a>
        
        <a id="interact-button-print"><button id="interact-button-download" class="interact-button">.pdf</button></a>
    </div>
</div>


  
  
  
  


</div>

  </div>
  <!-- Empty sidebar placeholder that we'll auto-fill with javascript -->
  <aside class="sidebar__right">
    <header><h4 class="nav__title"><img src="/assets/images/list-solid.svg" alt="Search" />   On this page</h4></header>
    <nav class="onthispage">
    </nav>
  </aside>
  <a href="/search.html" class="topbar-right-button" id="search-button">
    <img src="/assets/images/search-solid.svg" alt="Search" />
  </a>
</div>

      <main class="c-textbook__page" tabindex="-1">
            <div class="c-textbook__content" id="textbook_content">
              <h1 id="combining-flats">Combining flats</h1>

<p>There is one step in combining flats that is different from most other image
combination: the flats should be scaled to a common value before combining them.
This is particularly important if the flats are twilight flats in which the
average image value typically changes significantly as the images are being
taken.</p>

<p>Flats are typically grouped by filter when combining them. That is, one combined
flat is produced for each filter in which flats were taken.</p>

<p>Combination will be done for each of the two examples in the previous notebook.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">ccdproc</span> <span class="k">as</span> <span class="n">ccdp</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">mad_std</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">hist</span>

<span class="kn">from</span> <span class="nn">convenience_functions</span> <span class="kn">import</span> <span class="n">show_image</span>
</code></pre></div></div>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use custom style for larger fonts and figures</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'guide.mplstyle'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="example-1">Example 1</h2>

<p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/203/files#diff-3583e2ea4cfc457912d1f1b9414e63b2R53" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>We begin by setting up an image collection for the reduced data. This data is
from chip 0 of the cryogenically-cooled Large Format Camera at Palomar
Observatory.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">calibrated_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'example1-reduced'</span><span class="p">)</span>

<span class="n">flat_imagetyp</span> <span class="o">=</span> <span class="s">'flatfield'</span>

<span class="n">ifc</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">calibrated_path</span><span class="p">)</span>
</code></pre></div></div>

<p>We’ll first check what filters are present.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flat_filters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s">'filter'</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ifc</span><span class="o">.</span><span class="n">headers</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">))</span>
<span class="n">flat_filters</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"g'", "i'"}
</code></pre></div></div>

<p>These flats are dome flats, essentially pictures of a screen in the dome
illuminated by a light source, so you would not expect there to be much variable
in the typical pixel value between different exposures. There is typically
<em>some</em> variation, though, so we graph it below.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">median_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ifc</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">)]</span>
<span class="n">mean_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ifc</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">median_count</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'median'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_count</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Image number'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Count (ADU)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Pixel value in calibrated flat frames'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">median_count</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[20173.0, 20169.0, 20156.666666666668, 21026.0, 21042.333333333332, 21058.0]

</code></pre></div></div>

<p class="output output_png"><img src="images/05-04-Combining-flats_8_1.png" alt="png" /></p>

<p>Although this is less frame-to-frame variation than we will see in Example 2, it
is about 5%. If we were to combine these without scaling the flats to a common
value then the images with higher counts would effectively get more weight than
the images.</p>

<p>There is a substantial difference between the mean and median of this data.
Typically it is better to use the median because extreme values do not affect
the median as much as the mean.</p>

<p>To scale the frames so that they have the same median value, we need to define a
function that can calculate the inverse of the median given the data.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">inv_median</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div>

<p>This function is passed into the <code class="highlighter-rouge">scale</code> argument of <code class="highlighter-rouge">combine</code> below. One
combined flat is created for each filter in the data.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">flat_filters</span><span class="p">:</span>
    <span class="n">to_combine</span> <span class="o">=</span> <span class="n">ifc</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">include_path</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">combined_flat</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">to_combine</span><span class="p">,</span>
                                 <span class="n">method</span><span class="o">=</span><span class="s">'average'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">inv_median</span><span class="p">,</span>
                                 <span class="n">sigma_clip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                 <span class="n">sigma_clip_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">signma_clip_dev_func</span><span class="o">=</span><span class="n">mad_std</span><span class="p">,</span>
                                 <span class="n">mem_limit</span><span class="o">=</span><span class="mf">350e6</span>
                                <span class="p">)</span>

    <span class="n">combined_flat</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">'combined'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">dark_file_name</span> <span class="o">=</span> <span class="s">'combined_flat_filter_{}.fit'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"''"</span><span class="p">,</span> <span class="s">"p"</span><span class="p">))</span>
    <span class="n">combined_flat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">calibrated_path</span> <span class="o">/</span> <span class="n">dark_file_name</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO: splitting each image into 2 chunks to limit memory usage to 350000000.0 bytes. [ccdproc.combiner]
INFO: splitting each image into 2 chunks to limit memory usage to 350000000.0 bytes. [ccdproc.combiner]

</code></pre></div></div>

<h3 id="discussion-of-example-1">Discussion of Example 1</h3>

<p>We will begin by checking that the right number of combined flats have been
created. There were two filters, <code class="highlighter-rouge">g'</code> and <code class="highlighter-rouge">i'</code> in the raw data so there should
be two combined flats. We need to refresh the <code class="highlighter-rouge">ImageFileCollection</code> for the
reduced data because new files, our flats, have been added to them.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ifc</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
<span class="n">ifc</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array(["combined_flat_filter_g'.fit", "combined_flat_filter_i'.fit"],
      dtype='&lt;U27')
</code></pre></div></div>

<p>That looks good. The two flats are displayed below.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ifc</span><span class="o">.</span><span class="n">ccds</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">axes</span><span class="p">):</span>
    <span class="n">show_image</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s">"Filter {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">'filter'</span><span class="p">])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</code></pre></div></div>

<p class="output output_png"><img src="images/05-04-Combining-flats_17_0.png" alt="png" /></p>

<p>The first thing to notice is that the flats are different in these two filters.
That is expected because one of the elements in the optical path, the filter, is
different.</p>

<p>The pattern of electronics in the flat images is because this is a
backside-illuminated CCD. The light-detecting pixels are on the under side of
the chip and the light needs to pass through the chip to reach the sensor. The
small dark spots are places where the chip wasn’t thinned uniformly.</p>

<p>Compare this with <a href="#Discussion-of-Example-2">Example 2</a> below, which shows a flat
taken with a frontside-illuminated camera.</p>

<h2 id="example-2">Example 2</h2>

<p><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/pull/203/files#diff-3583e2ea4cfc457912d1f1b9414e63b2R241" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>The data in this example is from a thermoelectrically-cooled Andor Aspen CG16M.
These flats are twilight flats, taken just after sunset.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">calibrated_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'example2-reduced'</span><span class="p">)</span>

<span class="n">flat_imagetyp</span> <span class="o">=</span> <span class="s">'flat'</span>

<span class="n">ifc</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">calibrated_path</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flat_filters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s">'filter'</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ifc</span><span class="o">.</span><span class="n">headers</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">))</span>
<span class="n">flat_filters</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'r'}
</code></pre></div></div>

<p>Twilight flats typically differ more frame-to-frame than dome flats, as
shown in the figure below.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">median_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="n">ifc</span><span class="o">.</span><span class="n">hdus</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">)]</span>
<span class="n">mean_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ifc</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">median_count</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'median'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_count</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'mean'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Image number'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Count (ADU)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Pixel value in calibrated flat frames'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">median_count</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[45891.90222222222, 44225.99888888889, 43128.94777777778, 41495.89333333333, 39871.95111111111, 39019.864, 38817.97997777778, 38863.88776666667, 38822.93813333334, 38661.95832222222]

</code></pre></div></div>

<p class="output output_png"><img src="images/05-04-Combining-flats_23_1.png" alt="png" /></p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">inv_median</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">flat_filters</span><span class="p">:</span>
    <span class="n">to_combine</span> <span class="o">=</span> <span class="n">ifc</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">include_path</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">combined_flat</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">to_combine</span><span class="p">,</span>
                                 <span class="n">method</span><span class="o">=</span><span class="s">'average'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">inv_median</span><span class="p">,</span>
                                 <span class="n">sigma_clip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                 <span class="n">sigma_clip_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">signma_clip_dev_func</span><span class="o">=</span><span class="n">mad_std</span><span class="p">,</span>
                                 <span class="n">mem_limit</span><span class="o">=</span><span class="mf">350e6</span>
                                <span class="p">)</span>

    <span class="n">combined_flat</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s">'combined'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">dark_file_name</span> <span class="o">=</span> <span class="s">'combined_flat_filter_{}.fit'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"''"</span><span class="p">,</span> <span class="s">"p"</span><span class="p">))</span>
    <span class="n">combined_flat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">calibrated_path</span> <span class="o">/</span> <span class="n">dark_file_name</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO: splitting each image into 12 chunks to limit memory usage to 350000000.0 bytes. [ccdproc.combiner]

</code></pre></div></div>

<h3 id="discussion-of-example-2">Discussion of Example 2</h3>

<p>We expect only one combined flat because there was only one filter. The
<code class="highlighter-rouge">ImageFileCollection</code> is refreshed before we query it because the combined flats
were added after the collection was created.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ifc</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
<span class="n">ifc</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="n">flat_imagetyp</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array(['combined_flat_filter_r.fit'], dtype='&lt;U31')
</code></pre></div></div>

<p>The combined flat is displayed below.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">show_image</span><span class="p">(</span><span class="n">combined_flat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</code></pre></div></div>

<p class="output output_png"><img src="images/05-04-Combining-flats_29_0.png" alt="png" /></p>

<p>This flat looks very different than the one in <a href="#Discussion-of-Example-1">Example 1</a>
because this CCD is frontside-illuminated and the previous one is backside-illuminated. 
That means the sensor is on the top of the chip and the light does
not pass through the sensor chip itself to reach the sensors. Though only one
filter is shown here, the flat field looks slightly different through other
filters on this camera.</p>

            </div>
            <div class="c-textbook__footer" id="textbook_footer">
              <nav class="c-page__nav">
  
    
    <a id="js-page__nav__prev" class="c-page__nav__prev" href="/05-03-Calibrating-the-flats.html">
      〈 <span class="u-margin-right-tiny"></span> Calibrating flat frames
    </a>
  

  
    
    <a id="js-page__nav__next" class="c-page__nav__next" href="/06-00-Reducing-science-images.html">
      Calibrating science images <span class="u-margin-right-tiny"></span> 〉
    </a>
  
</nav>

              <footer>
  <p class="footer">This page was created by <a href="https://github.com/jupyter/jupyter-book/graphs/contributors">The Jupyter Book Community</a></p>
</footer>

            </div>

        </div>
      </main>
    </div>
  </body>
</html>
