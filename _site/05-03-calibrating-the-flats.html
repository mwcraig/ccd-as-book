<!DOCTYPE html>
<html lang="en">
  

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>Calibrating flat frames</title>
  <meta name="description" content="Calibrating the flats">

  <link rel="canonical" href="/YOUR%20URL//05-03-Calibrating-the-flats.html">
  <link rel="alternate" type="application/rss+xml" title="CCD Data Reduction Guide" href="/YOUR%20URL//feed.xml">

  <meta property="og:url"         content="/YOUR%20URL//05-03-Calibrating-the-flats.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Calibrating flat frames" />
<meta property="og:description" content="Calibrating the flats" />
<meta property="og:image"       content="" />


  <script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage":
    "YOUR URL//05-03-Calibrating-the-flats.html",
  "headline":
    "Calibrating flat frames",
  "datePublished":
    "2019-07-23T10:17:20-05:00",
  "dateModified":
    "2019-07-23T10:17:20-05:00",
  "description":
    "Calibrating the flats",
  "author": {
    "@type": "Person",
    "name": "Matthew Craig"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Data 100 at UC Berkeley",
    "logo": {
      "@type": "ImageObject",
      "url": "YOUR URL/",
      "width": 60,
      "height": 60
    }
  },
  "image": {
    "@type": "ImageObject",
    "url": "YOUR URL/",
    "height": 60,
    "width": 60
  }
}

  </script>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css ">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">

  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="/images/logo/favicon.ico">

  <!-- MathJax Config -->
  <!-- Allow inline math using $ and automatically break long math lines -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true,
        processEnvironments: true
    },
    CommonHTML: {
        linebreaks: {
            automatic: true,
        },
    },
});
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML' async></script>

  <!-- DOM updating function -->
  <script>
const runWhenDOMLoaded = cb => {
  if (document.readyState != 'loading') {
    cb()
  } else if (document.addEventListener) {
    document.addEventListener('DOMContentLoaded', cb)
  } else {
    document.attachEvent('onreadystatechange', function() {
      if (document.readyState == 'complete') cb()
    })
  }
}

// Helper function to init things quickly
initFunction = function(myfunc) {
  runWhenDOMLoaded(myfunc);
  document.addEventListener('turbolinks:load', myfunc);
};
</script>

  <!-- Define some javascript variables that will be useful in other javascript -->
  <script>
    const site_basename = '/';
  </script>

  <!-- Add AnchorJS to let headers be linked -->
  <script src="/assets/js/anchor.min.js"  type="text/javascript"></script>
  <script>

initFunction(function () {
    anchors.add("main h1, main h2, main h3, main h4")
});

</script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="/assets/js/turbolinks.js" async></script>
  <meta name="turbolinks-cache-control" content="no-cache">

  <!-- Load nbinteract for widgets -->
  <script src="https://unpkg.com/nbinteract-core" async></script>

  <!-- Load Thebelab for interactive widgets -->
  <!-- Include Thebelab for interactive code if it's enabled -->


  <!-- Google analytics -->
  <script src="/assets/js/ga.js" async></script>

  <!-- Clipboard copy button -->
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" async></script>

  <!-- Load JS that depends on site variables -->
  <script>
/**
 * Set up copy/paste for code blocks
 */
const codeCellId = index => `codecell${index}`

const clipboardButton = id =>
  `<a class="btn copybtn o-tooltip--left" data-tooltip="Copy" data-clipboard-target="#${id}">
    <img src="/assets/images/copy-button.svg" alt="Copy to clipboard">
  </a>`

// Clears selected text since ClipboardJS will select the text when copying
const clearSelection = () => {
  if (window.getSelection) {
    window.getSelection().removeAllRanges()
  } else if (document.selection) {
    document.selection.empty()
  }
}

// Changes tooltip text for two seconds, then changes it back
const temporarilyChangeTooltip = (el, newText) => {
  const oldText = el.getAttribute('data-tooltip')
  el.setAttribute('data-tooltip', newText)
  setTimeout(() => el.setAttribute('data-tooltip', oldText), 2000)
}

const addCopyButtonToCodeCells = () => {
  // If ClipboardJS hasn't loaded, wait a bit and try again. This
  // happens because we load ClipboardJS asynchronously.
  if (window.ClipboardJS === undefined) {
    setTimeout(addCopyButtonToCodeCells, 250)
    return
  }

  const codeCells = document.querySelectorAll('div.highlighter-rouge:not(.output) pre')
  codeCells.forEach((codeCell, index) => {
    const id = codeCellId(index)
    codeCell.setAttribute('id', id)
    if (document.querySelector(`pre#${id} + a`) == null) {
      codeCell.insertAdjacentHTML('afterend', clipboardButton(id));
    }
  })

  const clipboard = new ClipboardJS('.copybtn')
  clipboard.on('success', event => {
    clearSelection()
    temporarilyChangeTooltip(event.trigger, 'Copied!')
  })

  clipboard.on('error', event => {
    temporarilyChangeTooltip(event.trigger, 'Failed to copy')
  })

  // Get rid of clipboard before the next page visit to avoid memory leak
  document.addEventListener('turbolinks:before-visit', () =>
    clipboard.destroy()
  )
}

initFunction(addCopyButtonToCodeCells);
</script>

  <!-- Hide cell code -->
  
<script>
/**
Add buttons to hide code cells
*/


var setCodeCellVisibility = function(inputField, kind) {
    // Update the image and class for hidden
    var id = inputField.getAttribute('data-id');
    var codeCell = document.querySelector(`#${id}`);

    if (kind === "visible") {
        codeCell.classList.remove('hidden');
        inputField.checked = true;
    } else {
        codeCell.classList.add('hidden');
        inputField.checked = false;
    }
}

var toggleCodeCellVisibility = function (event) {
    // The label is clicked, and now we decide what to do based on the input field's clicked status
    if (event.target.tagName === "LABEL") {
        var inputField = event.target.previousElementSibling;
    } else {
        // It is the span inside the target
        var inputField = event.target.parentElement.previousElementSibling;
    }

    if (inputField.checked === true) {
        setCodeCellVisibility(inputField, "visible");
    } else {
        setCodeCellVisibility(inputField, "hidden");
    }
}


// Button constructor
const hideCodeButton = id => `<input class="hidebtn" type="checkbox" id="hidebtn${id}" data-id="${id}"><label title="Toggle cell" for="hidebtn${id}" class="plusminus"><span class="pm_h"></span><span class="pm_v"></span></label>`

var addHideButton = function () {
  // If a hide button is already added, don't add another
  if (document.querySelector('div.hidecode input') !== null) {
      return;
  }

  // Find the input cells and add a hide button
  document.querySelectorAll('div.input_area div.highlight').forEach(function (item, index) {
    if (!item.parentElement.classList.contains("hidecode")) {
        // Skip the cell if it doesn't have a hidecode class
        return;
    }

    const id = codeCellId(index)
    item.setAttribute('id', id);
    item.insertAdjacentHTML('afterend', hideCodeButton(id))

    // Set up the visibility toggle
    hideLink = document.querySelector(`#${id} + input + label`);
    hideLink.addEventListener('click', toggleCodeCellVisibility)
  });
}


// Initialize the hide buttos
var initHiddenCells = function () {
    // Add hide buttons to the cells
    addHideButton();

    // Toggle the code cells that should be hidden
    document.querySelectorAll('div.hidecode input').forEach(function (item) {
        setCodeCellVisibility(item, 'hidden');
        item.checked = true;
    })
}

initFunction(initHiddenCells);

</script>


  <!-- Load custom website scripts -->
  <script src="/assets/js/scripts.js" async></script>

  <!-- Load custom user CSS and JS  -->
  <script src="/assets/custom/custom.js" async></script>
  <link rel="stylesheet" href="/assets/custom/custom.css">

  <!-- Update interact links w/ REST param, is defined in includes so we can use templates -->
  

  <!-- Lunr search code - will only be executed on the /search page -->
  <script src="/assets/js/lunr/lunr.min.js" type="text/javascript"></script>
  <script>var initQuery = function() {
  // See if we have a search box
  var searchInput = document.querySelector('input#lunr_search');
  if (searchInput === null) {
    return;
  }

  // Function to parse our lunr cache
  var idx = lunr(function () {
    this.field('title')
    this.field('excerpt')
    this.field('categories')
    this.field('tags')
    this.ref('id')

    this.pipeline.remove(lunr.trimmer)

    for (var item in store) {
      this.add({
        title: store[item].title,
        excerpt: store[item].excerpt,
        categories: store[item].categories,
        tags: store[item].tags,
        id: item
      })
    }
  });

  // Run search upon keyup
  searchInput.addEventListener('keyup', function () {
    var resultdiv = document.querySelector('#results');
    var query = document.querySelector("input#lunr_search").value.toLowerCase();
    var result =
      idx.query(function (q) {
        query.split(lunr.tokenizer.separator).forEach(function (term) {
          q.term(term, { boost: 100 })
          if(query.lastIndexOf(" ") != query.length-1){
            q.term(term, {  usePipeline: false, wildcard: lunr.Query.wildcard.TRAILING, boost: 10 })
          }
          if (term != ""){
            q.term(term, {  usePipeline: false, editDistance: 1, boost: 1 })
          }
        })
      });

      // Empty the results div
      while (resultdiv.firstChild) {
        resultdiv.removeChild(resultdiv.firstChild);
      }

    resultdiv.insertAdjacentHTML('afterbegin', '<p class="results__found">'+result.length+' Result(s) found</p>');
    for (var item in result) {
      var ref = result[item].ref;
      if(store[ref].teaser){
        var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<div class="archive__item-teaser">'+
                '<img src="'+store[ref].teaser+'" alt="">'+
              '</div>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      else{
    	  var searchitem =
          '<div class="list__item">'+
            '<article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">'+
              '<h2 class="archive__item-title" itemprop="headline">'+
                '<a href="'+store[ref].url+'" rel="permalink">'+store[ref].title+'</a>'+
              '</h2>'+
              '<p class="archive__item-excerpt" itemprop="description">'+store[ref].excerpt.split(" ").splice(0,20).join(" ")+'...</p>'+
            '</article>'+
          '</div>';
      }
      resultdiv.insertAdjacentHTML('beforeend', searchitem);
    }
  });
};

initFunction(initQuery);
</script>
</head>

  <body>
    <!-- .js-show-sidebar shows sidebar by default -->
    <div id="js-textbook" class="c-textbook js-show-sidebar">
      



<nav id="js-sidebar" class="c-textbook__sidebar">
  <a href="https://jupyter.org/jupyter-book/"><img src="/images/logo/logo.png" class="textbook_logo" id="sidebar-logo" data-turbolinks-permanent/></a>
  <h2 class="c-sidebar__title">CCD Data Reduction Guide</h2>
  <ul class="c-sidebar__chapters">
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/00-00-Preface.html"
        >
          
          Home
        </a>

        
      </li>

      
    
      
      
        <li class="c-sidebar__chapter"><a class="c-sidebar__entry" href="/search.html">Search</a></li>
        
      
      
        <li class="c-sidebar__divider"></li>
        
      
      
        <li><h2 class="c-sidebar__title">CCD Data Reduction Guide</li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/01-00-Understanding-an-astronomical-CCD-image.html"
        >
          
            1.
          
          Understanding astronomical images
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-03-Construction-of-an-artificial-but-realistic-image.html"
                >
                  
                    1.1
                  
                  An artificial, but realistic, image
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-04-Nonuniform-sensitivity.html"
                >
                  
                    1.2
                  
                  Non-uniform sensitivity in astronomical detectors
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-05-Calibration-overview.html"
                >
                  
                    1.3
                  
                  Calibration overview
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-06-Image-combination.html"
                >
                  
                    1.4
                  
                  Image combination
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-08-Overscan.html"
                >
                  
                    1.5
                  
                  Overscan
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-09-Calibration-choices-you-need-to-make.html"
                >
                  
                    1.6
                  
                  Calibration choices to make
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/01-11-reading-images.html"
                >
                  
                    1.7
                  
                  Reading images
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/02-00-Handling-overscan-trimming-and-bias-subtraction.html"
        >
          
            2.
          
          Overscan and bias images
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/02-01-Calibrating-bias-images.html"
                >
                  
                    2.1
                  
                  Calibrating bias images
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/02-04-Combine-bias-images-to-make-master.html"
                >
                  
                    2.2
                  
                  Combine bias images to make master bias
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/03-00-Dark-current-and-hot-pixels.html"
        >
          
            3.
          
          Dark current and dark frames
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-01-Dark-current-The-ideal-case.html"
                >
                  
                    3.1
                  
                  Dark current: the ideal case
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-02-Real-dark-current-noise-and-other-artifacts.html"
                >
                  
                    3.2
                  
                  Real dark current: noise and other artifacts
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-04-Handling-overscan-and-bias-for-dark-frames.html"
                >
                  
                    3.3
                  
                  Handling overscan and bias for dark frames
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-05-Calibrate-dark-images.html"
                >
                  
                    3.4
                  
                  Calibrate dark images
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/03-06-Combine-darks-for-use-in-later-calibration-steps.html"
                >
                  
                    3.5
                  
                  Combine calibrated dark images for use in later reduction steps
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/05-00-Flat-corrections.html"
        >
          
            4.
          
          Flat fielding
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry c-sidebar__entry--active"
                  href="/05-03-Calibrating-the-flats.html"
                >
                  
                    4.1
                  
                  Calibrating flat frames
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/05-04-Combining-flats.html"
                >
                  
                    4.2
                  
                  Combining flat frames
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/06-00-Reducing-science-images.html"
        >
          
            5.
          
          Calibrating science images
        </a>

        
      </li>

      
    
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="/08-00-Image-masking.html"
        >
          
            6.
          
          Finding and dealing with bad pixels
        </a>

        

          
          
          
          

          

          <ul class="c-sidebar__sections ">
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-01-Identifying-hot-pixels.html"
                >
                  
                    6.1
                  
                  Identifying hot pixels
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-02-Creating-a-mask.html"
                >
                  
                    6.2
                  
                  Identifying bad pixels with ccdmask
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-03-Cosmic-ray-removal.html"
                >
                  
                    6.3
                  
                  Removing cosmic rays
                </a>

                
                

              </li>
              
            
              
              

              <li class="c-sidebar__section">
                <a class="c-sidebar__entry "
                  href="/08-05-incorporating-masks-into-calibrated-science-images.html"
                >
                  
                    6.4
                  
                  Incorporating masks in science images
                </a>

                
                

              </li>
              
            
          </ul>
        
      </li>

      
    
      
      
        <li class="c-sidebar__divider"></li>
        
      
      

      
      

      
      
      <li class="c-sidebar__chapter">
        <a class="c-sidebar__entry "
          href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide"
        >
          
          GitHub repository
        </a>

        
      </li>

      
    
  </ul>
  <p class="sidebar_footer">Powered by <a href="https://github.com/jupyter/jupyter-book">Jupyter Book</a> and <a href="https://astropy.org">Astropy</a></p>
</nav>

      
      <!-- Shamelessly copied from minimal mistakes -->


<!-- TOC will only show up if it has at least one item -->


  <aside class="sidebar__right">
    <nav class="onthispage">
      <header><h4 class="nav__title"><i class="fa fa-list"></i>   On this page</h4></header>
      <ul class="toc__menu">
  <li><a href="#function-definition">Function definition</a></li>
  <li><a href="#subtract-overscan-and-trim-if-necessary">Subtract overscan and trim, if necessary</a></li>
  <li><a href="#subtracting-bias-is-not-necessary-in-this-example">Subtracting bias is not necessary in this example</a></li>
  <li><a href="#subtract-dark-current-no-scaling-necessary-in-this-example">Subtract dark current, no scaling necessary in this example</a></li>
  <li><a href="#calibrated-all-of-the-flats-in-the-folder">Calibrated all of the flats in the folder</a></li>
  <li><a href="#subtract-overscan-and-trim-only-trim-for-this-camera">Subtract overscan and trim: only trim for this camera</a></li>
  <li><a href="#subtracting-bias-is-necessary">Subtracting bias is necessary</a></li>
  <li><a href="#subtract-dark-current-scaling-as-needed">Subtract dark current, scaling as needed</a></li>
  <li><a href="#calibrated-all-of-the-flats-in-the-folder-1">Calibrated all of the flats in the folder</a></li>
</ul>
    </nav>
  </aside>


      
      <main class="c-textbook__page" tabindex="-1">
          <div class="o-wrapper">
            <div class="c-sidebar-toggle">
  <!-- We show the sidebar by default so we use .is-active -->
  <button
    id="js-sidebar-toggle"
    class="hamburger hamburger--arrowalt is-active"
  >
    <span class="hamburger-box">
      <span class="hamburger-inner"></span>
    </span>
    <span class="c-sidebar-toggle__label">Toggle Sidebar</span>
  </button>
</div>

            
<div class="buttons">
<a href="/content/05-03-Calibrating-the-flats.ipynb" download>
<button id="interact-button-download" class="interact-button">Download</button>
</a>





</div>


            <div class="c-textbook__content">
              <h1 id="calibrating-the-flats">Calibrating the flats</h1>

<p>Recall that the counts in an astronomical image include dark current, noise and
a nearly-constant offset, the bias. The individual flat frames need to have bias
and dark removed from them. Depending on the exposure times of the images you
have, you may or may not need to subtract dark and bias separately.</p>

<p>If the combined dark frame needs to be scaled to a different exposure time then
bias and dark must be handled separately; otherwise, the dark and bias can be
removed in a single step because dark frames also include bias.</p>

<p>The potential reduction steps for flat frames are below:</p>

<ul>
  <li>Subtract overscan and trim, if necessary</li>
  <li>Subtract bias, if necessary</li>
  <li>Subtract dark current, scaling if necessary (scale down when possible)</li>
</ul>

<p>As in the chapters about bias and dark we will work through two example. In
Example 1 the darks are not scaled and the overscan region is used as part of
the calibration. In Example 2 the darks are scaled and the overscan region is
trimmed off without being used.</p>

<h3 id="function-definition">Function definition</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R34" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>The function below finds the nearest dark exposure time to the exposure time of
a given image. An exception is raised if the difference in exposure time is
larger than <code class="highlighter-rouge">tolerance</code>, unless <code class="highlighter-rouge">tolerance</code> is set to <code class="highlighter-rouge">None</code>. A small numerical
tolerance is most useful if you anticipate not scaling the dark frames and
finding a dark exposure time close to the time of the image. Disregarding the
tolerance is useful if the intent is to scale the dark frames anyway.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_nearest_dark_exposure</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dark_exposure_times</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="s">"""
    Find the nearest exposure time of a dark frame to the exposure time of the image,
    raising an error if the difference in exposure time is more than tolerance.
    
    Parameters
    ----------
    
    image : astropy.nddata.CCDData
        Image for which a matching dark is needed.
    
    dark_exposure_times : list
        Exposure times for which there are darks.
    
    tolerance : float or ``None``, optional
        Maximum difference, in seconds, between the image and the closest dark. Set
        to ``None`` to skip the tolerance test.
    
    Returns
    -------
    
    float
        Closest dark exposure time to the image.
    """</span>

    <span class="n">dark_exposures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dark_exposure_times</span><span class="p">))</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">dark_exposures</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]))</span>
    <span class="n">closest_dark_exposure</span> <span class="o">=</span> <span class="n">dark_exposures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> 
        <span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]</span> <span class="o">-</span> <span class="n">closest_dark_exposure</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">):</span>
        
        <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'Closest dark exposure time is {} for flat of exposure '</span>
                           <span class="s">'time {}.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">closest_dark_exposure</span><span class="p">,</span> <span class="n">a_flat</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]))</span>
        
    
    <span class="k">return</span> <span class="n">closest_dark_exposure</span>
</code></pre></div></div>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">CCDData</span>
<span class="kn">import</span> <span class="nn">ccdproc</span> <span class="k">as</span> <span class="n">ccdp</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="kn">from</span> <span class="nn">convenience_functions</span> <span class="kn">import</span> <span class="n">show_image</span>
</code></pre></div></div>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use custom style for larger fonts and figures</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'guide.mplstyle'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="example-1-no-scaling-of-dark-frames">Example 1: no scaling of dark frames</h2>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R120" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>The images for this example are from chip 0 of the Large Format Camera at
Palomar Observatory. The raw images are at XXX, and this notebook assumes that
you have worked through the notebooks on bias and dark so that there is a folder
called <code class="highlighter-rouge">example1-reduced</code> in the same folder as this notebook.</p>

<p>We’ll go through this example twice: once with a single image to explain each
step, then processing all of the flat frames in the directory of raw data.</p>

<p>An image collection is defined below, along with a couple of settings useful for
this example.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reduced_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'example1-reduced'</span><span class="p">)</span>

<span class="n">ifc_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">reduced_path</span><span class="p">)</span>

<span class="n">combined_dark_files</span> <span class="o">=</span> <span class="n">ifc_reduced</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'dark'</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">flat_image_type</span> <span class="o">=</span> <span class="s">'FLATFIELD'</span>
</code></pre></div></div>

<p>The raw data should be in the directory <code class="highlighter-rouge">example-cryo-LFC</code></p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'example-cryo-LFC'</span><span class="p">)</span>

<span class="n">ifc_raw</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</code></pre></div></div>

<p>The cell below checks that the files needed are available.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_combined_dark</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_dark_files</span><span class="p">)</span>
<span class="n">expected_exposure_times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>

<span class="k">if</span> <span class="n">n_combined_dark</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'One or more combined dark is missing. Please re-run the dark notebook.'</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">n_combined_dark</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'There are more combined dark frames than expected.'</span><span class="p">)</span>
    
<span class="n">actual_exposure_times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ifc_reduced</span><span class="o">.</span><span class="n">headers</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'dark'</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="k">if</span> <span class="p">(</span><span class="n">expected_exposure_times</span> <span class="o">-</span> <span class="n">actual_exposure_times</span><span class="p">):</span>
    <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'Encountered unexpected exposure time in combined darks. '</span>
                       <span class="s">'The unexpected times are {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_exposure_times</span> <span class="o">-</span> <span class="n">expected_exposure_times</span><span class="p">))</span>
</code></pre></div></div>

<p>First, get one of the flat frames as a <code class="highlighter-rouge">CCDData</code> object and display it.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a_flat</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ifc_raw</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'flatfield'</span><span class="p">,</span> <span class="n">include_path</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">'adu'</span><span class="p">)</span>

<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_12_0.png" alt="png" /></p>

<p>There is not a lot of variation in this. Note that the overscan region on the
right stands out as a black bar, and that there is apparently also an overscan
region across the top of the chip. There appears to be a slight variaion in
pixel values from the bottom to the top of the image.</p>

<h3 id="subtract-overscan-and-trim-if-necessary">Subtract overscan and trim, if necessary</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R227" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>The overscan is useful for the LFC and needs to be subtracted and trimmed off.
See <a href="03-05-Calibrate-dark-images.html#Decide-which-calibration--steps-to-take">this example in the dark reduction notebook</a> for a review of the overscan parameters.
The overscan region is the Python slice <code class="highlighter-rouge">[:, 2055:]</code> while the region to be
retained after trimming is the Python slice <code class="highlighter-rouge">[:, :2048]</code>.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Subtract the overscan</span>
<span class="n">a_flat_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_overscan</span><span class="p">(</span><span class="n">a_flat</span><span class="p">,</span> <span class="n">overscan</span><span class="o">=</span><span class="n">a_flat</span><span class="p">[:,</span> <span class="mi">2055</span><span class="p">:],</span> <span class="n">median</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Trim the overscan</span>
<span class="n">a_flat_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">])</span>

<span class="c"># Display the result so far</span>
<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Single flat frame, overscan subtracted and trimmed'</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Single flat frame, overscan subtracted and trimmed')
</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_15_1.png" alt="png" /></p>

<p>Trimming off the overscan makes such a big difference primarily because the
image stretch changed; the lowest pixel values are now around 18000 instead of</p>
<ol>
  <li>With that change the non-uniformity across the detector is much clearer.</li>
</ol>

<h3 id="subtracting-bias-is-not-necessary-in-this-example">Subtracting bias is not necessary in this example</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R265" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>For this particular set of images there are darks with exposure time 7, 70 and
300 sec. The flat images have the exposure times listed below:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span><span class="p">(</span><span class="n">ifc_raw</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">][</span><span class="n">ifc_raw</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s">'imagetyp'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'FLATFIELD'</span><span class="p">])</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{7.0, 70.001, 70.011}
</code></pre></div></div>

<p>These are close enough to the exposure time of the dark frames that there is no
need to scale the darks by exposure time. If the darks are not going to be
scaled then there is no need to subtract the bias.</p>

<h3 id="subtract-dark-current-no-scaling-necessary-in-this-example">Subtract dark current, no scaling necessary in this example</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R293" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>We need to subtract the dark without scaling it. Rather than manually figuring
out which dark to subtract we use the dark frame closest in exposure time to the
flat, within a tolerance of 1 second to ensure that we do not end up using a
dark <em>too</em> far off in exposure time from the flat.</p>

<p>First, find the dark exposure time closest to the flat. We will need to do this
again later in the notebook, so we define a function to do it.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">closest_dark</span> <span class="o">=</span> <span class="n">find_nearest_dark_exposure</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">actual_exposure_times</span><span class="p">)</span>
</code></pre></div></div>

<p>It will be convenient to be able to access the darks via a dictionary whose key
is the exposure time, so we set that up below.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined_darks</span> <span class="o">=</span> <span class="p">{</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]:</span> <span class="n">ccd</span> <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ifc_reduced</span><span class="o">.</span><span class="n">ccds</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'dark'</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">)}</span>
</code></pre></div></div>

<p>Next, we subtract the dark from the flat and display the result.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a_flat_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_dark</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">combined_darks</span><span class="p">[</span><span class="n">closest_dark</span><span class="p">],</span> 
                                    <span class="n">exposure_time</span><span class="o">=</span><span class="s">'exptime'</span><span class="p">,</span> <span class="n">exposure_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_25_0.png" alt="png" /></p>

<p>There is not much change here; that is not surprising since the dark current in
this camera is low.</p>

<h3 id="calibrated-all-of-the-flats-in-the-folder">Calibrated all of the flats in the folder</h3>

<p>The cell below calibrates each of the flats in the folder, automatically
grabbing the correct combined dark for each flat.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">ifc_raw</span><span class="o">.</span><span class="n">ccds</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'FLATFIELD'</span><span class="p">,</span>            <span class="c"># Just get the bias frames</span>
                                         <span class="n">ccd_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'unit'</span><span class="p">:</span> <span class="s">'adu'</span><span class="p">},</span> <span class="c"># CCDData requires a unit for the image if </span>
                                                                     <span class="c"># it is not in the header</span>
                                         <span class="n">return_fname</span><span class="o">=</span><span class="bp">True</span>           <span class="c"># Provide the file name too.</span>
                                        <span class="p">):</span>    
    <span class="c"># Subtract the overscan</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_overscan</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">overscan</span><span class="o">=</span><span class="n">ccd</span><span class="p">[:,</span> <span class="mi">2055</span><span class="p">:],</span> <span class="n">median</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c"># Trim the overscan</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2048</span><span class="p">])</span>
    
    <span class="c"># Find the correct dark exposure</span>
    <span class="n">closest_dark</span> <span class="o">=</span> <span class="n">find_nearest_dark_exposure</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">actual_exposure_times</span><span class="p">)</span>
    
    <span class="c"># Subtract the dark current </span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_dark</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">combined_darks</span><span class="p">[</span><span class="n">closest_dark</span><span class="p">],</span>
                             <span class="n">exposure_time</span><span class="o">=</span><span class="s">'exptime'</span><span class="p">,</span> <span class="n">exposure_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>

    <span class="c"># Save the result; there are some duplicate file names so pre-pend "flat"</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reduced_path</span> <span class="o">/</span> <span class="p">(</span><span class="s">'flat-'</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="example-2-dark-frames-are-scaled">Example 2: Dark frames are scaled</h2>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R403" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>The images in this example, like in the previous notebooks, is a
thermo-electrically cooled CCD described in more detail in the
<a href="01-08-Overscan.html#Case-2:-Thermo-electrically-cooled-Apogee-Aspen-CG16M">overscan notebook</a>.</p>

<p>We’ll go through this example twice: once with a single image to explain each
step, then processing all of the flat frames in the directory of raw data.</p>

<p>An image collection is defined below, along with a couple of settings useful for
this example.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">reduced_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'example2-reduced'</span><span class="p">)</span>

<span class="n">ifc_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">reduced_path</span><span class="p">)</span>

<span class="n">combined_dark_files</span> <span class="o">=</span> <span class="n">ifc_reduced</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'dark'</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">flat_image_type</span> <span class="o">=</span> <span class="s">'FLAT'</span>
</code></pre></div></div>

<p>The raw data should be in the directory <code class="highlighter-rouge">example-thermo-electric</code></p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'example-thermo-electric'</span><span class="p">)</span>

<span class="n">ifc_raw</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</code></pre></div></div>

<p>The cell below checks that the files needed are available.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_combined_dark</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_dark_files</span><span class="p">)</span>

<span class="n">n_dark_expected</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">expected_exposure_times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="mi">90</span><span class="p">])</span>

<span class="k">if</span> <span class="n">n_combined_dark</span> <span class="o">&lt;</span> <span class="n">n_dark_expected</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'One or more combined dark is missing. Please re-run the dark notebook.'</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">n_combined_dark</span> <span class="o">&gt;</span> <span class="n">n_dark_expected</span><span class="p">:</span>
    <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'There are more combined dark frames than expected.'</span><span class="p">)</span>
    
<span class="n">actual_exposure_times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ifc_reduced</span><span class="o">.</span><span class="n">headers</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'dark'</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="k">if</span> <span class="p">(</span><span class="n">expected_exposure_times</span> <span class="o">-</span> <span class="n">actual_exposure_times</span><span class="p">):</span>
    <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">'Encountered unexpected exposure time in combined darks. '</span>
                       <span class="s">'The unexpected times are {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">actual_exposure_times</span> <span class="o">-</span> <span class="n">expected_exposure_times</span><span class="p">))</span>
</code></pre></div></div>

<p>First, get one of the flat frames as a <code class="highlighter-rouge">CCDData</code> object and display it.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a_flat</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ifc_raw</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'flat'</span><span class="p">,</span> <span class="n">include_path</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">'adu'</span><span class="p">)</span>

<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_stream highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO: using the unit adu passed to the FITS reader instead of the unit adu in the FITS file. [astropy.nddata.ccddata]

</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_37_1.png" alt="png" /></p>

<p>There is a much different pattern of variation across the sensor in this case
than in Example 1. The multiple “donuts” in the image are pieces of dust and
there is significant vignetting (darkening) in the top and bottom corners of the
image on the right side.</p>

<h3 id="subtract-overscan-and-trim-only-trim-for-this-camera">Subtract overscan and trim: only trim for this camera</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R511" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>The overscan is not useful for this camera. The region to be retained after
trimming is the Python slice <code class="highlighter-rouge">[:, :4096]</code>.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Trim the overscan</span>
<span class="n">a_flat_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">a_flat</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4096</span><span class="p">])</span>

<span class="c"># Display the result so far</span>
<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Single flat frame, overscan trimmed'</span><span class="p">)</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Text(0.5, 1.0, 'Single flat frame, overscan trimmed')
</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_40_1.png" alt="png" /></p>

<p>Trimming off the overscan did not make a big difference primarily because the
overscan region of this camera is not useful. A useful overscan would have had
values around the bias level for this camera, about 1200 counts. The image
stretch did change a bit; prior to trimming the lower end of the color scale was
38000 and now it is 40000.</p>

<h3 id="subtracting-bias-is-necessary">Subtracting bias is necessary</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R546" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>For this particular set of images there is a combined dark with exposure time 90
sec. The flat images have the exposure times listed below:</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span><span class="p">(</span><span class="n">ifc_raw</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">][</span><span class="n">ifc_raw</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s">'imagetyp'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'FLAT'</span><span class="p">])</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{1.0, 1.02, 1.06, 1.11, 1.16, 1.21}
</code></pre></div></div>

<p>These are quite different than the exposure time of the dark frames so the dark
will need to be scaled by exposure time, which means that the bias has been
removed from the combined dark.</p>

<p>Because of that, the bias needs to be removed the flat before subtracting the
dark.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined_bias</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ifc_reduced</span><span class="o">.</span><span class="n">ccds</span><span class="p">(</span><span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">imagetyp</span><span class="o">=</span><span class="s">'bias'</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a_flat_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_bias</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">combined_bias</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Display the result so far</span>
<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Single flat frame, overscan trimmed and bias subtracted'</span><span class="p">);</span>
</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_46_0.png" alt="png" /></p>

<p>Except for a change in the image scale shown on the color bar there isn’t much
visually different after subtracting the bias.</p>

<h3 id="subtract-dark-current-scaling-as-needed">Subtract dark current, scaling as needed</h3>

<p><a href="https://github.com/mwcraig/ccd-reduction-and-photometry-guide/pull/122/files#diff-bd41f594acd69139c487547a641d2628R606" target="_blank"><em>Click here to comment on this section on GitHub (opens in new tab).</em></a></p>

<p>Here we will need to scale the dark from the 90 sec exposure time of the dark
frame to the exposure time of each flat image. The <a href="">ccdproc function
<code class="highlighter-rouge">subtract_dark</code></a> provides keywords for doing this scaling automatically.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">closest_dark</span> <span class="o">=</span> <span class="n">find_nearest_dark_exposure</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">actual_exposure_times</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>It will be convenient to be able to access the darks via a dictionary whose key
is the exposure time, so we set that up below.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">combined_darks</span> <span class="o">=</span> <span class="p">{</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">'exptime'</span><span class="p">]:</span> <span class="n">ccd</span> <span class="k">for</span> <span class="n">ccd</span> <span class="ow">in</span> <span class="n">ifc_reduced</span><span class="o">.</span><span class="n">ccds</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'dark'</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="bp">True</span><span class="p">)}</span>
<span class="n">combined_darks</span>
</code></pre></div></div>

<div class="output output_data_text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{90.0: CCDData([[  7.04545455,  47.22727273,  39.80909091, ...,   3.59090909,
             5.78181818,   1.03636364],
          [  2.37272727,  55.59090909,  34.18181818, ...,   7.25454545,
            -4.23636364,   5.05454545],
          [ -3.00909091,  50.66363636,  37.44545455, ...,   9.79090909,
             6.12727273,   9.63636364],
          ...,
          [  3.4       ,   5.78181818,   9.63636364, ...,  -2.03636364,
             6.95454545,   2.47272727],
          [  1.2       ,  11.52727273,   7.39090909, ...,   0.27272727,
            12.70909091,  -2.27272727],
          [ -0.2       , -11.03636364,   1.4       , ...,  -0.61818182,
             1.51818182,   5.15454545]])}
</code></pre></div></div>

<p>Next, we subtract the dark from the flat and display the result.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a_flat_reduced</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_dark</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">combined_darks</span><span class="p">[</span><span class="n">closest_dark</span><span class="p">],</span> 
                                    <span class="n">exposure_time</span><span class="o">=</span><span class="s">'exptime'</span><span class="p">,</span> <span class="n">exposure_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">show_image</span><span class="p">(</span><span class="n">a_flat_reduced</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
</code></pre></div></div>

<p class="output output_png"><img src="images/05-03-Calibrating-the-flats_53_0.png" alt="png" /></p>

<p>There is not much change here; that is not surprising since the dark current in
this camera is low.</p>

<h3 id="calibrated-all-of-the-flats-in-the-folder-1">Calibrated all of the flats in the folder</h3>

<p>The cell below calibrates each of the flats in the folder, automatically
grabbing the correct combined dark for each flat.</p>

<div class="language-python input_area highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">ifc_raw</span><span class="o">.</span><span class="n">ccds</span><span class="p">(</span><span class="n">imagetyp</span><span class="o">=</span><span class="s">'FLAT'</span><span class="p">,</span>            <span class="c"># Just get the bias frames</span>
                                   <span class="n">return_fname</span><span class="o">=</span><span class="bp">True</span>           <span class="c"># Provide the file name too.</span>
                                  <span class="p">):</span>
        
    <span class="c"># Trim the overscan</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4096</span><span class="p">])</span>
    
    <span class="c"># Find the correct dark exposure</span>
    <span class="n">closest_dark</span> <span class="o">=</span> <span class="n">find_nearest_dark_exposure</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">actual_exposure_times</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c"># Subtract the dark current </span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdp</span><span class="o">.</span><span class="n">subtract_dark</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">combined_darks</span><span class="p">[</span><span class="n">closest_dark</span><span class="p">],</span>
                             <span class="n">exposure_time</span><span class="o">=</span><span class="s">'exptime'</span><span class="p">,</span> <span class="n">exposure_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># Save the result</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reduced_path</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">)</span>
</code></pre></div></div>


              <nav class="c-page__nav">
  
    
    <a id="js-page__nav__prev" class="c-page__nav__prev" href="/05-00-Flat-corrections">
      〈 <span class="u-margin-right-tiny"></span> Flat fielding
    </a>
  

  
    
    <a id="js-page__nav__next" class="c-page__nav__next" href="/05-04-Combining-flats">
      Combining flat frames <span class="u-margin-right-tiny"></span> 〉
    </a>
  
</nav>

            </div>
          </div>
        </div>
      </main>
    </div>

  </body>
</html>
